<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ê–Ω—Ç–∏-–ú–æ—à–µ–Ω–Ω–∏–∫ ‚Äî –ò–ò –°–∞–º–æ—É—á–∫–∞ (–±–µ–∑ –ë–î)</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --accent:#1f2937; --muted:#6b7280; --primary:#1e40af;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:var(--bg); color:#111;}
    header{background:linear-gradient(90deg,#0f172a 0%, #111827 100%); color:#fff; padding:24px 20px; text-align:center}
    header h1{margin:0;font-size:20px}
    header p{margin:6px 0 0;color:rgba(255,255,255,0.85);font-size:13px}
    .container{max-width:1000px;margin:22px auto;padding:0 16px;}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);}
    .full{grid-column:1 / -1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"], textarea, select{
      width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px;
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center}
    button{
      background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;
      font-weight:600;font-size:14px;
    }
    button.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--accent)}
    .result{margin-top:12px;padding:12px;border-radius:8px;background:#f8fafc;border-left:4px solid var(--primary)}
    .news-list article{padding:12px 0;border-bottom:1px dashed #eef2ff}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:var(--primary);font-size:12px;margin-right:6px}
    .history-item{padding:10px;border:1px solid #eef2ff;border-radius:8px;margin-bottom:8px;background:#fff}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .flex{display:flex;gap:8px;align-items:center}
    footer{text-align:center;padding:18px;color:var(--muted);font-size:13px;margin-top:22px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>

<header>
  <h1>üõ°Ô∏è –ê–Ω—Ç–∏-–ú–æ—à–µ–Ω–Ω–∏–∫ ‚Äî –ò–ò –°–∞–º–æ—É—á–∫–∞ (–±–µ–∑ –ë–î)</h1>
  <p>–í—Å—ë —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä.</p>
</header>

<div class="container">
  <div class="grid">
    <!-- LEFT: Analyzer + News -->
    <div class="card">
      <h2 style="margin:0 0 8px 0">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è / —Å—Å—ã–ª–∫–∏</h2>
      <div class="muted small">–í—Å—Ç–∞–≤—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫—É –∏ –Ω–∞–∂–º–∏ ¬´–ü—Ä–æ–≤–µ—Ä–∏—Ç—å¬ª.</div>

      <div style="margin-top:12px">
        <label>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å / —Å—Å—ã–ª–∫–∞</label>
        <input id="inpSender" type="text" placeholder="example@site.com –∏–ª–∏ https://site.com">
      </div>

      <div style="margin-top:10px">
        <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
        <textarea id="inpText" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞, SMS –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
      </div>

      <div style="margin-top:12px" class="row">
        <button id="btnAnalyze">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="btnClear" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
        <button id="btnAI" class="ghost">–ò–ò –∞–Ω–∞–ª–∏–∑</button>

        <div style="margin-left:auto" class="muted small" id="analyzeTime">‚Äî</div>
      </div>

      <div id="resultBox" class="result" style="display:none"></div>

      <div style="margin-top:12px" class="controls">
        <button id="btnMarkPhishing" class="ghost">–ü–æ–º–µ—Ç–∏—Ç—å: –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ</button>
        <button id="btnMarkLegit" class="ghost">–ü–æ–º–µ—Ç–∏—Ç—å: –±–µ–∑–æ–ø–∞—Å–Ω–æ</button>
        <button id="btnExport" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã</button>
        <input id="fileImport" type="file" accept=".json" style="display:none">
        <button id="btnImport" class="ghost">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã</button>
        <button id="btnClearStorage" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
      </div>
    </div>

    <!-- RIGHT: Dashboard / Trainer -->
    <div class="card">
      <h3 style="margin:0 0 8px 0">–ò–ò ‚Äî –°–∞–º–æ–æ–±—É—á–µ–Ω–∏–µ (–ª–æ–∫–∞–ª—å–Ω–æ)</h3>
      <div class="muted small">–ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è –ø—Ä–∏–º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø–æ–º–µ—Ç–∏–ª–∏. –î–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>

      <div style="margin-top:10px" id="stats" class="small">
        <div>–í—Å–µ–≥–æ –ø—Ä–∏–º–µ—Ä–æ–≤: <strong id="statCount">0</strong></div>
        <div>–ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ: <strong id="statPhish">0</strong></div>
        <div>–ë–µ–∑–æ–ø–∞—Å–Ω–æ: <strong id="statLegit">0</strong></div>
      </div>

      <div style="margin-top:12px;max-height:420px;overflow:auto" id="historyList"></div>
    </div>

    <!-- FULL: News -->
    <div class="card full">
      <h3 style="margin:0 0 8px 0">–ù–æ–≤–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä—ã)</h3>
      <div class="muted small">–ü–æ–∫–∞ —á—Ç–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–µ —Å—Ç–∞—Ç—å–∏. –ü–æ–∑–∂–µ –ø–æ–¥–∫–ª—é—á–∏–º RSS/API.</div>

      <div class="news-list" style="margin-top:12px">
        <article>
          <div class="tag">CISA</div>
          <h4 style="margin:6px 0">–ù–æ–≤–∞—è –≤–æ–ª–Ω–∞ —Ñ–∏—à–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ QR-–∫–æ–¥—ã</h4>
          <div class="muted small">–ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏ —Ä–∞—Å—Å—ã–ª–∞—é—Ç QR-–∫–æ–¥—ã, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—â–∏–µ –Ω–∞ —Ñ–∞–ª—å—à–∏–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞.</div>
        </article>

        <article>
          <div class="tag">Krebs</div>
          <h4 style="margin:6px 0">–ü–æ–¥–¥–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç –±–∞–Ω–∫–æ–≤</h4>
          <div class="muted small">–†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ —Å—á—ë—Ç–∞ —Å –ø—Ä–æ—Å—å–±–æ–π –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ.</div>
        </article>

        <article>
          <div class="tag">NCSC</div>
          <h4 style="margin:6px 0">–ö–∞–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–∏—à–∏–Ω–≥–æ–≤–æ–µ –ø–∏—Å—å–º–æ</h4>
          <div class="muted small">–°–æ–≤–µ—Ç—ã: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–º–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –Ω–µ –≤–≤–æ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 2FA.</div>
        </article>
      </div>
    </div>

  </div> <!-- grid -->
</div> <!-- container -->

<footer>
  ¬© 2025 –ê–Ω—Ç–∏-–ú–æ—à–µ–Ω–Ω–∏–∫ ‚Äî –ü—Ä–æ—Ç–æ—Ç–∏–ø. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (localStorage). –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–Ω—ã.
</footer>

<script>
/*
  –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞:
  - –∞–Ω–∞–ª–∏–∑ (heuristics + –ø—Ä–æ—Å—Ç–æ–π —Å–∫–æ—Ä)
  - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–º–µ—Ç–æ–∫ –≤ localStorage –ø–æ–¥ –∫–ª—é—á–æ–º "antiphish_examples"
  - —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç JSON
  - –Ω–µ—Ç –±—ç–∫–µ–Ω–¥–∞ / –Ω–µ—Ç –ë–î
*/

// -------------------- Helpers --------------------
function nowIso(){ return new Date().toISOString(); }
function uid(){ return 'ex_' + Math.random().toString(36).slice(2,9); }
function saveExamples(list){ localStorage.setItem('antiphish_examples', JSON.stringify(list)); }
function loadExamples(){ try{ return JSON.parse(localStorage.getItem('antiphish_examples')||'[]') }catch(e){ return [] } }

// -------------------- Analysis --------------------
function analyzeText(sender, text){
  const s = (sender||'').trim().toLowerCase();
  const t = (text||'').trim().toLowerCase();
  let score = 0;
  const reasons = [];

  // sender checks
  if(s && !s.includes('@') && s.startsWith('http')){ score += 15; reasons.push('–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å ‚Äî —Å—Å—ã–ª–∫–∞/–Ω–µ email'); }
  if(s && s.includes('@') && s.split('@')[1] && s.split('@')[1].split('.').length === 1){
    score += 12; reasons.push('–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –¥–æ–º–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è');
  }
  // common phishing triggers
  const triggers = ['—Å—Ä–æ—á–Ω–æ','–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ','–ø–∞—Ä–æ–ª—å','–≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ','–æ–±–Ω–æ–≤–∏—Ç–µ','—É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ','–Ω–∞–ª–∏—á–∏–µ —à—Ç—Ä–∞—Ñ–∞','–±–ª–æ–∫–∏—Ä–æ–≤–∫','–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'];
  triggers.forEach(tr=>{
    if(t.includes(tr)){ score += 18; reasons.push('–ù–∞–π–¥—ë–Ω —Ç—Ä–∏–≥–≥–µ—Ä: "'+tr+'"'); }
  });
  // URLs in text
  const urlRegex = /https?:\/\/[^\s/$.?#].[^\s]*/gi;
  const urls = (t.match(urlRegex) || []).slice(0,5);
  if(urls.length) {
    score += Math.min(30, urls.length * 12);
    reasons.push('–ù–∞–π–¥–µ–Ω–∞ —Å—Å—ã–ª–∫–∞(–∏): ' + urls.join(', '));
  }
  // short message + urgent word -> increase
  if(t.length < 80 && (t.includes('—Å—Ä–æ—á–Ω–æ') || t.includes('–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ'))) { score += 10; reasons.push('–ö–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é'); }

  // clamp score
  score = Math.min(100, Math.max(0, score));

  // suggestions
  const suggestions = [];
  suggestions.push('–ù–µ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–∞–º –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ–º–µ–Ω–∞.');
  suggestions.push('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–∏—Å—å–º–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ).');
  suggestions.push('–ù–µ –≤–≤–æ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª–∏/–ö–æ–¥—ã 2FA –∏–∑ –ø–∏—Å–µ–º/—Å–æ–æ–±—â–µ–Ω–∏–π.');

  return {score, reasons, suggestions, urls};
}

// -------------------- UI --------------------
const inpSender = document.getElementById('inpSender');
const inpText = document.getElementById('inpText');
const btnAnalyze = document.getElementById('btnAnalyze');
const btnClear = document.getElementById('btnClear');
const resultBox = document.getElementById('resultBox');
const analyzeTime = document.getElementById('analyzeTime');

const btnMarkPhishing = document.getElementById('btnMarkPhishing');
const btnMarkLegit = document.getElementById('btnMarkLegit');
const historyList = document.getElementById('historyList');
const statCount = document.getElementById('statCount');
const statPhish = document.getElementById('statPhish');
const statLegit = document.getElementById('statLegit');

const btnExport = document.getElementById('btnExport');
const btnImport = document.getElementById('btnImport');
const fileImport = document.getElementById('fileImport');
const btnClearStorage = document.getElementById('btnClearStorage');

let lastAnalysis = null;

function renderResult(res){
  if(!res){ resultBox.style.display='none'; return; }
  let html = `<div style="font-weight:700;margin-bottom:6px">–†–∏—Å–∫ —Ñ–∏—à–∏–Ω–≥–∞: ${res.score}%</div>`;
  if(res.reasons && res.reasons.length){
    html += '<div class="small muted"><strong>–ü–æ—á–µ–º—É:</strong></div><ul>';
    res.reasons.forEach(r => html += `<li style="margin:4px 0">${r}</li>`);
    html += '</ul>';
  }
  html += '<div class="small muted" style="margin-top:8px"><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong></div><ul>';
  res.suggestions.forEach(s => html += `<li style="margin:4px 0">${s}</li>`);
  html += '</ul>';
  if(res.urls && res.urls.length){
    html += `<div style="margin-top:8px" class="small muted">–°—Å—ã–ª–∫–∏: ${res.urls.join(', ')}</div>`;
  }
  resultBox.innerHTML = html;
  resultBox.style.display = 'block';
}

// Analyze button
btnAnalyze.addEventListener('click', ()=>{
  const s = inpSender.value;
  const t = inpText.value;
  const t0 = performance.now();
  const res = analyzeText(s,t);
  const t1 = performance.now();
  analyzeTime.textContent = `–í—Ä–µ–º—è: ${(t1-t0).toFixed(1)} ms`;
  renderResult(res);
  lastAnalysis = {sender:s, text:t, analysis:res, time: nowIso()};
});

// Clear button
btnClear.addEventListener('click', ()=>{
  inpSender.value=''; inpText.value=''; renderResult(null); analyzeTime.textContent='‚Äî'; lastAnalysis = null;
});

// Marking (save example)
function addExample(label){
  // label: 'phishing' | 'legit'
  const examples = loadExamples();
  const example = {
    id: uid(),
    label,
    sender: inpSender.value,
    text: inpText.value,
    analysis: lastAnalysis ? lastAnalysis.analysis : analyzeText(inpSender.value, inpText.value),
    created: nowIso()
  };
  examples.unshift(example);
  saveExamples(examples);
  renderHistory();
  alert('–ü—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ: ' + label);
}

btnMarkPhishing.addEventListener('click', ()=> addExample('phishing'));
btnMarkLegit.addEventListener('click', ()=> addExample('legit'));

// History & stats
function renderHistory(){
  const examples = loadExamples();
  statCount.textContent = examples.length;
  statPhish.textContent = examples.filter(e=>e.label==='phishing').length;
  statLegit.textContent = examples.filter(e=>e.label==='legit').length;

  historyList.innerHTML = '';
  if(examples.length === 0){
    historyList.innerHTML = '<div class="muted small">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤. –ü–æ–º–µ—Ç—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ.</div>';
    return;
  }
  examples.forEach(ex=>{
    const el = document.createElement('div');
    el.className = 'history-item';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <div style="font-weight:600">${ex.label==='phishing' ? 'üö© –ú–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ' : '‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ'}</div>
        <div class="muted small">${(new Date(ex.created)).toLocaleString()}</div>
      </div>
      <div class="muted small" style="margin-top:6px"><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${ex.sender || '(–Ω–µ —É–∫–∞–∑–∞–Ω)'}</div>
      <div style="margin-top:8px">${ex.text ? `<pre style="white-space:pre-wrap;font-family:inherit">${escapeHtml(ex.text)}</pre>` : '<div class="muted small">(–±–µ–∑ —Ç–µ–∫—Å—Ç–∞)</div>'}</div>
      <div style="margin-top:8px" class="small muted"><strong>–ê–Ω–∞–ª–∏–∑:</strong> –†–∏—Å–∫ ${ex.analysis.score}% ‚Äî ${ex.analysis.reasons.slice(0,2).join('; ')}</div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="ghost" onclick="deleteExample('${ex.id}')">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="ghost" onclick="copyExample('${ex.id}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å JSON</button>
      </div>
    `;
    historyList.appendChild(el);
  });
}

// escape HTML for safe display
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// delete example
window.deleteExample = function(id){
  const arr = loadExamples().filter(x=>x.id!==id);
  saveExamples(arr);
  renderHistory();
}

// copy JSON of a single example
window.copyExample = function(id){
  const ex = loadExamples().find(x=>x.id===id);
  if(!ex) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ');
  navigator.clipboard.writeText(JSON.stringify(ex, null, 2)).then(()=>alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'));
}

// export all examples
btnExport.addEventListener('click', ()=>{
  const data = loadExamples();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'antiphish_examples.json';
  document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
});

// import examples (merge)
btnImport.addEventListener('click', ()=> fileImport.click());
fileImport.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(){ 
    try{
      const imported = JSON.parse(reader.result);
      if(!Array.isArray(imported)) throw new Error('JSON –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∞—Å—Å–∏–≤–æ–º –ø—Ä–∏–º–µ—Ä–æ–≤');
      const existing = loadExamples();
      // add imported with new ids if duplicates
      imported.forEach(it=>{
        if(!it.id) it.id = uid();
        existing.unshift(it);
      });
      saveExamples(existing);
      renderHistory();
      alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: ' + imported.length);
    }catch(err){
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ: ' + err.message);
    }
  };
  reader.readAsText(f);
});

// clear storage
btnClearStorage.addEventListener('click', ()=>{
  if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞?')) {
    localStorage.removeItem('antiphish_examples');
    renderHistory();
  }
});

// load on start
renderHistory();

// simple UX: press Ctrl+Enter in textarea triggers analyze
inpText.addEventListener('keydown', (e)=>{
  if(e.ctrlKey && e.key === 'Enter'){ btnAnalyze.click(); }
});

</script>

<script>
  // -------------------- AI Integration (robust) --------------------
(function(){
  // ensure required DOM nodes exist
  const analyzeWrapper = document.querySelector('.row') || document.body;
  let btnAI = document.getElementById('btnAI');

  // If btnAI missing ‚Äî create it next to Analyze button
  if (!btnAI) {
    btnAI = document.createElement('button');
    btnAI.id = 'btnAI';
    btnAI.className = 'ghost';
    btnAI.textContent = '–ò–ò –∞–Ω–∞–ª–∏–∑';
    // try to insert after Analyze button
    const analyzeBtn = document.getElementById('btnAnalyze');
    if (analyzeBtn && analyzeBtn.parentNode) {
      analyzeBtn.parentNode.insertBefore(btnAI, analyzeBtn.nextSibling);
    } else {
      analyzeWrapper.appendChild(btnAI);
    }
  }

  // helper to display raw debug info
  function showRaw(data) {
    const pre = document.createElement('pre');
    pre.style.whiteSpace = 'pre-wrap';
    pre.style.fontSize = '12px';
    pre.style.marginTop = '10px';
    pre.textContent = JSON.stringify(data, null, 2);
    // append but avoid duplicates
    const existing = document.getElementById('rawAIResp');
    if (existing) existing.remove();
    pre.id = 'rawAIResp';
    resultBox.appendChild(pre);
  }

  btnAI.addEventListener('click', async () => {
    const text = inpText.value.trim();
    if (!text) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');

    resultBox.style.display = 'block';
    resultBox.innerHTML = 'ü§ñ –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ...';

    try {
      const res = await fetch('/api/classify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      // network errors
      if (!res.ok) {
        const txt = await res.text().catch(()=>'<–Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞>');
        throw new Error(`HTTP ${res.status}: ${txt}`);
      }

      // try parse json
      let data;
      try { data = await res.json(); } 
      catch (e) { 
        const txt = await res.text();
        throw new Error('–û—Ç–≤–µ—Ç –Ω–µ JSON: ' + txt);
      }

      // show raw data for debugging
      resultBox.innerHTML = '<div style="font-weight:700;margin-bottom:6px">–û—Ç–≤–µ—Ç –æ—Ç –ò–ò (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)</div>';
      showRaw(data);

      // normalize various possible server responses:
      // - uClassify JSON REST: an array [{ classification: [...] , text: "..." }]
      // - server returned data[0] already: { classification: [...] }
      // - other shapes
      let cls = null;
      if (Array.isArray(data) && data.length > 0 && data[0].classification) cls = data[0].classification;
      else if (data.classification) cls = data.classification;
      else if (data && data[0] && data[0].classification) cls = data[0].classification;

      if (!cls) {
        resultBox.insertAdjacentHTML('beforeend', '<div style="color:orange;margin-top:8px">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ <code>classification</code> –≤ –æ—Ç–≤–µ—Ç–µ –ò–ò.</div>');
        return;
      }

      // find phishing/legit probabilities (case-insensitive)
      const getP = (name) => {
        const found = cls.find(c => String(c.className).toLowerCase().includes(name));
        return found ? (found.p ?? found.probability ?? found.score ?? 0) : 0;
      };

      const phishing = getP('phish');
      const legit = getP('legit') || getP('safe') || (1 - phishing);

      const confidence = Math.max(phishing, legit) * 100;
      const verdict = phishing > legit ? '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ' : '‚úÖ –ü–æ—Ö–æ–∂–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ';
      const color = phishing > legit ? 'red' : 'green';

      // append verdict
      const verdictHtml = `
        <div style="font-weight:700;margin-top:10px;color:${color}">${verdict}</div>
        <div class="small muted">–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ò–ò: ${confidence.toFixed(1)}%</div>
        <div style="margin-top:8px" class="small muted">–ò—Å—Ç–æ—á–Ω–∏–∫: uClassify (—á–µ—Ä–µ–∑ –≤–∞—à —Å–µ—Ä–≤–µ—Ä)</div>
      `;
      resultBox.insertAdjacentHTML('beforeend', verdictHtml);

    } catch (err) {
      console.error('AI error:', err);
      resultBox.innerHTML = `<span style="color:red">–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –ò–ò: ${err.message}</span>`;
    }
  });
})();

</script>

</body>
</html>
